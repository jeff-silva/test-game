var w=Object.defineProperty;var x=(i,t,e)=>t in i?w(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var r=(i,t,e)=>x(i,typeof t!="symbol"?t+"":t,e);import{_ as v}from"./CGQIBMYx.js";import{u as C,n as b,p as k,m as B,w as P,o as A,a as p}from"./DdYu8N3N.js";import{O as d}from"./D3Mqfikn.js";import{f as L,S as _,P as M,C as S,W as U,g as u,E as D,L as R,c as E,d as z,e as y}from"./OOJU6yUV.js";import{G as H}from"./D-qi7e-V.js";const T=()=>{const i=C();return{baseUrl:(e="")=>{let n=new URL(location.href).origin;return i.app.baseURL&&(i.app.baseURL.startsWith("/")||(n+="/"),n+=i.app.baseURL,!i.app.baseURL.endsWith("/")&&!e.startsWith("/")&&(n+="/"),n+=e),n}}},F=class{constructor(t={}){r(this,"options",{el:null,debug:!1});r(this,"instances",[]);console.clear(),this.options={...this.options,...t},this.extensions().map(e=>{this[e.name]=new e.class(this)})}extensions(){return[{name:"preload",class:I},{name:"event",class:j},{name:"input",class:G},{name:"canvas",class:W},{name:"game",class:X},{name:"physics",class:q}]}init(){setTimeout(async()=>{await d.init(),await this.preload.init(this.preloadFiles()),this.create(),this.update()},10)}create(){this.extensions().map(t=>{this[t.name].onCreate()}),this.onCreate(),this.event.dispatch("create"),this.instances.map(t=>{t.onCreate()})}update(){this.extensions().map(t=>{this[t.name].onUpdate()}),this.onUpdate(),this.event.dispatch("update"),this.instances.map(t=>{t.onUpdate()}),requestAnimationFrame(()=>this.update())}destroy(){this.extensions().map(t=>{this[t.name].onDestroy()}),this.onDestroy(),this.event.dispatch("destroy"),this.instances.map(t=>{t.onDestroy()})}onCreate(){}onUpdate(){}onDestroy(){}preloadFiles(){return{}}instanceAdd(t){t.parent=this,this.instances.push(t)}},f=class{constructor(){r(this,"parent",null)}onCreate(){}onUpdate(){}onDestroy(){}};class h{constructor(t){this.parent=t}onCreate(){}onUpdate(){}onDestroy(){}}class I extends h{constructor(){super(...arguments);r(this,"files",{})}init(e={}){return new Promise((s,n)=>{Object.entries(e).length==0&&s();const o={gltf:a=>new H(c).load(a.url,l=>{a.loaded=!0,a.model=l})},c=Object.assign(new L,{onProgress:(a,l,m)=>{const g=l/m*100;this.parent.event.dispatch("preload.loading.progress",{progress:g,url:a,itemsLoaded:l,itemsTotal:m})},onLoad:()=>{this.parent.event.dispatch("preload.loading.success"),s()}});Object.entries(e).map(([a,l])=>{l.name=a,l.loaded=!1,l.ext=l.url.split("?").at(0).split(".").at(-1),l.content=null,typeof o[l.ext]=="function"&&o[l.ext](l),this.files[a]=l})})}}class j extends h{constructor(){super(...arguments);r(this,"events",[])}on(e,s){this.events.push({name:e,callback:s})}dispatch(...e){const s=e,n=s.shift();this.events.filter(o=>o.name==n).map(({name:o,callback:c})=>{c.apply(this,s)})}}class G extends h{constructor(){super(...arguments);r(this,"keyboard",{});r(this,"mouse",{click:{x:0,y:0},movement:{x:0,y:0},offset:{x:0,y:0}})}onCreate(){this.getEvents().map(e=>{document.addEventListener(...e)})}onDestroy(){this.getEvents().map(e=>{document.removeEventListener(...e)})}eventHandler(e,s){if(["input",`input.${s.type}`,`input.${e.type}`].map(o=>{this.parent.event.dispatch(o,e)}),e.type=="keydown"&&(this.keyboard[e.key]=!0,this.keyboard[e.code]=!0,this.keyboard[e.keyCode]=!0),e.type=="keyup"&&(delete this.keyboard[e.key],delete this.keyboard[e.code],delete this.keyboard[e.keyCode]),e.type=="click"&&(this.mouse.click.x=e.offsetX,this.mouse.click.y=e.offsetY),["mousemove","pointermove"].includes(e.type))for(let o in this.mouse)typeof e[`${o}X`]>"u"||(this.mouse[o].x=e[`${o}X`],this.mouse[o].y=e[`${o}Y`])}getEvents(){let e=[{type:"mouse",name:"click"},{type:"mouse",name:"mouseenter"},{type:"mouse",name:"mouseleave"},{type:"mouse",name:"mousemove"},{type:"mouse",name:"pointermove"},{type:"mouse",name:"pointerdown"},{type:"mouse",name:"pointerout"},{type:"mouse",name:"pointerlockchange"},{type:"keyboard",name:"keyup"},{type:"keyboard",name:"keydown"}],s=[];return e.map(n=>{s.push([n.name,o=>this.eventHandler(o,n)])}),s}}class W extends h{constructor(){super(...arguments);r(this,"el",null);r(this,"width",0);r(this,"height",0)}onCreate(){const{options:e}=this.parent;this.el=document.querySelector(e.el),this.resizeHandler(),window.addEventListener("resize",()=>{this.resizeHandler(),this.parent.event.dispatch("canvas.resize",{width:this.width,height:this.height})})}resizeHandler(){this.width=this.el.offsetWidth,this.height=this.el.offsetHeight}}class X extends h{onCreate(){const{width:t,height:e}=this.parent.canvas,{canvas:s}=this.parent;this.scene=new _,this.camera=new M(50,t/e,1,1e3),this.clock=new S,this.renderer=new U({antialias:!0}),s.el.innerHTML="",s.el.style.position="relative",s.el.style.minHeight="100px",s.el.appendChild(this.renderer.domElement),this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%",this.resizeHandler(t,e),this.parent.event.on("canvas.resize",({width:n,height:o})=>{this.resizeHandler(n,o)})}onUpdate(){this.renderer.render(this.scene,this.camera)}resizeHandler(t,e){this.renderer.setSize(t,e),this.camera.aspect=t/e,this.camera.updateProjectionMatrix()}getPointerLockControls(t={}){const e=new Proxy({target:null,pointerSpeed:1,minPolarAngle:0,maxPolarAngle:Math.PI,updateAxisX:!0,updateAxisY:!0,...t,locked:!1,script:this,lock:()=>{this.parent.canvas.el.requestPointerLock()},moveForward(s){const n=e.target,o=new u;o.setFromMatrixColumn(n.matrix,0),o.crossVectors(n.up,o),n.position.addScaledVector(o,s)},moveRight(s){const n=e.target,o=new u;o.setFromMatrixColumn(n.matrix,0),n.position.addScaledVector(o,s)}},{get(s,n){return n=="locked"?!!document.pointerLockElement:s[n]}});return this.parent.event.on("input.click",s=>{(this.parent.canvas.el==s.target||this.parent.canvas.el.contains(s.target))&&e.lock()}),this.parent.event.on("input.pointermove",s=>{if(!e.locked||!e.target)return;const n=Math.PI/2,o=e.target,c=.002*e.pointerSpeed,a=new D(0,0,0,"YXZ");a.setFromQuaternion(o.quaternion),e.updateAxisY&&(a.y-=s.movementX*c),e.updateAxisX&&(a.x-=s.movementY*c,a.x=Math.max(n-e.maxPolarAngle,Math.min(n-e.minPolarAngle,a.x))),o.quaternion.setFromEuler(a)}),e}}class q extends h{constructor(){super(...arguments);r(this,"debug",!1);r(this,"scene",null);r(this,"world",null);r(this,"dynamicBodies",[])}onCreate(){this.world=new d.World({x:0,y:-9.81,z:0}),this.parent.options.debug&&(this.debug=new Y(this.parent.game.scene,this.world))}onUpdate(){this.dynamicBodies.map(({mesh:s,body:n,shape:o})=>{n&&(typeof n.translation=="function"&&s.position.copy(n.translation()),typeof n.rotation=="function"&&s.quaternion.copy(n.rotation()))}),this.parent.options.debug&&this.debug&&this.world&&this.debug.update();const e=this.parent.game.clock.getDelta();this.world.timestep=Math.min(e,.1),this.world.step()}dynamicBodyAdd({mesh:e,body:s,shape:n}){const o=this.world.createCollider(n,s);this.dynamicBodies.push({collider:o,mesh:e,body:s,shape:n})}characterController(){return new class{constructor(e){r(this,"parent",null);r(this,"controller",null);r(this,"collider",null);this.parent=e,this.collider=(()=>{let s=new d.RigidBodyDesc(d.RigidBodyType.KinematicPositionBased),n=e.world.createRigidBody(s),o=new d.ColliderDesc(new d.Cuboid(.5,.5,.5));return e.world.createCollider(o,n)})(),this.controller=e.world.createCharacterController(.01),this.controller.setSlideEnabled(!0),this.controller.setMaxSlopeClimbAngle(45*Math.PI/180),this.controller.setMinSlopeSlideAngle(30*Math.PI/180),this.controller.enableAutostep(.5,.2,!0),this.controller.enableSnapToGround(.5),this.controller.setApplyImpulsesToDynamicBodies(!0),this.controller.setCharacterMass(1)}move(e){let s=parent.world.createRigidBody(new d.RigidBodyDesc(d.RigidBodyType.KinematicPositionBased));const n=parent.world.createCollider(new d.ColliderDesc(new d.Cuboid(.5,.5,.5)),s);let o=new u;o.x+=1,this.controller.computeColliderMovement(n,o);for(var c=0;c<controller.numComputedCollisions();c++)controller.computedCollision(c);movement.copy(controller.computedMovement()),nextTranslation.copy(s.translation()),nextTranslation.add(movement),s.setNextKinematicTranslation(nextTranslation)}}(this)}}class Y{constructor(t,e){r(this,"mesh");r(this,"world");r(this,"enabled",!0);this.world=e,this.mesh=new R(new E,new z({color:16777215,vertexColors:!0})),this.mesh.frustumCulled=!1,t.add(this.mesh)}update(){if(this.enabled){const{vertices:t,colors:e}=this.world.debugRender();this.mesh.geometry.setAttribute("position",new y(t,3)),this.mesh.geometry.setAttribute("color",new y(e,4)),this.mesh.visible=!0}else this.mesh.visible=!1}}const ee={__name:"rapier-04",setup(i){const t=T();class e extends F{preloadFiles(){return{level:{url:t.baseUrl("assets/threejs/models/low-poly-level/scene.gltf")}}}onCreate(){this.instanceAdd(new s),this.instanceAdd(new n)}}class s extends f{onCreate(){const a=this.parent.preload.files.level.model.scene;this.parent.game.scene.add(a)}}class n extends f{onCreate(){}}const o=new e({el:"#game",debug:!0});return o.event.on("destroy",()=>{location.reload()}),b(()=>{o.init()}),k(()=>{o.destroy()}),(c,a)=>{const l=v;return A(),B(l,{name:"main"},{default:P(()=>a[0]||(a[0]=[p("div",{id:"game",style:{width:"100%",height:"400px",position:"relative"}},null,-1),p("a",{href:""},"Refresh",-1),p("div",{style:{height:"100vh"}},null,-1)])),_:1})}}};export{ee as default};
