var b=Object.defineProperty;var x=(h,e,t)=>e in h?b(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var n=(h,e,t)=>x(h,typeof e!="symbol"?e+"":e,t);import{u as k}from"./B6jcXzCi.js";import{O as c,a as v}from"./DLb91F2m.js";import{T as C,S as R,C as S,W as M,f as P,P as E,g as m,E as L,O as A,M as T,h as D,B,i as U,L as j,c as F,d as G,e as y}from"./OOJU6yUV.js";import{G as H}from"./D-qi7e-V.js";const O=class{constructor(e,t){n(this,"mesh");n(this,"world");n(this,"enabled",!0);this.world=t,this.mesh=new j(new F,new G({color:16777215,vertexColors:!0})),this.mesh.frustumCulled=!1,e.add(this.mesh)}update(){if(this.enabled){const{vertices:e,colors:t}=this.world.debugRender();this.mesh.geometry.setAttribute("position",new y(e,3)),this.mesh.geometry.setAttribute("color",new y(t,4)),this.mesh.visible=!0}else this.mesh.visible=!1}},_=class{constructor(e={}){n(this,"options",{el:null,debug:!1});n(this,"canvas",{el:null,width:0,height:0});n(this,"scene",null);n(this,"camera",null);n(this,"clock",null);n(this,"renderer",null);n(this,"debug",null);n(this,"world",null);n(this,"dynamicBodies",[]);n(this,"THREE",null);n(this,"RAPIER",null);n(this,"events",[]);n(this,"scripts",[]);n(this,"input",{mouse:{click:{x:0,y:0},movement:{x:0,y:0},offset:{x:0,y:0}},keyboard:{},joystick:{}});this.options={el:null,...e},this.THREE=C,this.RAPIER=c}init(){return new Promise((e,t)=>{setTimeout(async()=>{await c.init(),await this.initCanvas(),await this.initGame(),await this.initRapier(),await this.initPreload(),await this.initCanvas(),await this.initInputEvents(),await this.initUpdate(),e({})},10)})}destroy(){this.dispatch("destroy")}async initCanvas(){this.canvas.el||(this.canvas.el=document.querySelector(this.options.el),window.addEventListener("resize",async()=>{await this.initCanvas()})),this.canvas.el&&(this.canvas.width=this.canvas.el.offsetWidth,this.canvas.height=this.canvas.el.offsetHeight),this.camera&&(this.camera.aspect=this.canvas.width/this.canvas.height,this.camera.updateProjectionMatrix()),this.renderer&&this.renderer.setSize(this.canvas.width,this.canvas.height)}async initGame(){this.scene||(this.scene=new R,this.scene.name=this.scene.name||"Main Scene"),this.camera||(this.camera=this.cameraDefault()),this.clock||(this.clock=new S),this.renderer||(this.renderer=new M({antialias:!0}),this.canvas.el.innerHTML="",this.canvas.el.style.position="relative",this.canvas.el.style.minHeight="100px",this.canvas.el.appendChild(this.renderer.domElement),this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%")}async initRapier(){this.world=new c.World({x:0,y:-9.81,z:0}),this.options.debug&&(this.debug=new O(this.scene,this.world)),this.on("update",()=>{this.debug&&this.world&&this.debug.update()})}initPreload(){return new Promise((e,t)=>{const i=k(),s=Object.assign(new P,{onProgress:(r,a,d)=>{const u=a/d*100;this.dispatch("loadProgress",{progress:u,url:r,itemsLoaded:a,itemsTotal:d})},onLoad:()=>{this.dispatch("loadSuccess"),e()}}),o={gltf:r=>new H(s).load(r.url,a=>{r.loaded=!0,r.model=a,r.onLoad(r)})};let l=this.preload();Object.entries(l).map(([r,a])=>{if(a={name:r,onLoad:()=>null,...a,ext:a.url.split("?").at(0).split(".").at(-1),loaded:!1,model:null},!a.url.startsWith("http")){const d=new URL(location.href),u=a.url;a.url=d.origin,i.app.baseURL&&(i.app.baseURL.startsWith("/")||(a.url+="/"),a.url+=i.app.baseURL,!i.app.baseURL.endsWith("/")&&!u.startsWith("/")&&(a.url+="/"),a.url+=u)}typeof o[a.ext]=="function"&&o[a.ext](a)})})}async initInputEvents(){let e=[{type:"mouse",name:"click"},{type:"mouse",name:"mouseenter"},{type:"mouse",name:"mouseleave"},{type:"mouse",name:"mousemove"},{type:"mouse",name:"pointermove"},{type:"mouse",name:"pointerdown"},{type:"mouse",name:"pointerout"},{type:"mouse",name:"pointerlockchange"},{type:"keyboard",name:"keyup"},{type:"keyboard",name:"keydown"}];const t=(s,o)=>{["input",`input.${o.type}`,`input.${s.type}`].map(r=>{if(this.dispatch(r,s),s.type=="keydown"&&(this.input.keyboard[s.key]=!0,this.input.keyboard[s.code]=!0,this.input.keyboard[s.keyCode]=!0),s.type=="keyup"&&(this.input.keyboard[s.key]=null,this.input.keyboard[s.code]=null,this.input.keyboard[s.keyCode]=null),s.type=="click"&&(this.input.mouse.click.x=s.offsetX,this.input.mouse.click.y=s.offsetY),["mousemove","pointermove"].includes(s.type))for(let a in this.input.mouse)typeof s[`${a}X`]>"u"||(this.input.mouse[a].x=s[`${a}X`],this.input.mouse[a].y=s[`${a}Y`])})};let i=[];e.map(s=>{const o=l=>t(l,s);i.push({...s,handler:o})}),i.map(s=>{document.addEventListener(s.name,s.handler)}),this.on("destroy",()=>{i.map(s=>{document.removeEventListener(s.name,s.handler)})})}async initUpdate(){this.onCreate(),this.dispatch("create");const e=()=>{this.onUpdate(),this.dispatch("update"),this.scripts.map(i=>{i.onUpdate()}),this.dynamicBodies.map(({mesh:i,body:s,shape:o})=>{s&&(i.position.copy(s.translation()),i.quaternion.copy(s.rotation()))});const t=this.clock.getDelta();this.world.timestep=Math.min(t,.1),this.world.step(),this.renderer.render(this.scene,this.camera),requestAnimationFrame(e)};requestAnimationFrame(e)}preload(){return{}}on(e,t){this.events.push({name:e,callback:t})}dispatch(...e){const t=e,i=t.shift();this.events.filter(s=>s.name==i).map(({name:s,callback:o})=>{o.apply(this,t)}),this.parent&&this.parent.dispatch(...e)}cameraDefault(){const{width:e,height:t}=this.canvas;return new E(50,e/t,1,1e3)}getOrbitControls(e=null,t=null){e=e||this.camera,t=t||this.renderer;const i=new v(e,t.domElement);return this.on("update",()=>{i.update()}),i}getPointerLockControls(e={}){const t=new Proxy({target:null,pointerSpeed:1,minPolarAngle:0,maxPolarAngle:Math.PI,updateAxisX:!0,updateAxisY:!0,...e,locked:!1,script:this,lock(){this.script.canvas.el.requestPointerLock()},moveForward(i){const s=t.target,o=new m;o.setFromMatrixColumn(s.matrix,0),o.crossVectors(s.up,o),s.position.addScaledVector(o,i)},moveRight(i){const s=t.target,o=new m;o.setFromMatrixColumn(s.matrix,0),s.position.addScaledVector(o,i)}},{get(i,s){return s=="locked"?!!document.pointerLockElement:i[s]}});return this.on("input.click",i=>{(this.canvas.el==i.target||this.canvas.el.contains(i.target))&&t.lock()}),this.on("input.pointermove",i=>{if(!t.locked||!t.target)return;const s=Math.PI/2,o=t.target,l=.002*t.pointerSpeed,r=new L(0,0,0,"YXZ");r.setFromQuaternion(o.quaternion),t.updateAxisY&&(r.y-=i.movementX*l),t.updateAxisX&&(r.x-=i.movementY*l,r.x=Math.max(s-t.maxPolarAngle,Math.min(s-t.minPolarAngle,r.x))),o.quaternion.setFromEuler(r)}),t}scriptAttach(e,t){t.object=e,t.scene=this,this.scripts.push(t),t.onCreate()}addPhysics(e){let t={};t.mesh=new A,t.body=void 0,t.shape=c.ColliderDesc.cuboid(.5,.5,.5).setMass(1).setRestitution(1.1),t=e(t),this.scene.add(t.mesh),this.world.createCollider(t.shape,t.body),this.dynamicBodies.push(t)}basicMeshPhysicsAdd(e={}){e={geometry:{},position:{x:0,y:0,z:0},material:{},body:{},...e},e.geometry=new f().optionsMerge(e.geometry||{}),e.material=new g().optionsMerge(e.material||{}),e.body=new w().optionsMerge(e.body||{});let t={};const i=new f(e.geometry).get(),s=new g(e.material).get(),o=new W(e.geometry).get(),l=new w(e.body).get();return t.mesh=new T(i,s),t.mesh.position.set(e.position.x,e.position.y,e.position.z),t.body=this.world.createRigidBody(l.setCanSleep(e.body.canSleep).setTranslation(e.position.x,e.position.y,e.position.z)),t.shape=o.setMass(e.body.mass).setRestitution(e.body.restitution),this.scene.add(t.mesh),this.world.createCollider(t.shape,t.body),this.dynamicBodies.push(t),t}physicsAttach(e,t={}){}onCreate(){}onUpdate(){}},K=class{constructor(){n(this,"object",null);n(this,"scene",null)}onCreate(){}onUpdate(){}};class p{constructor(e={}){n(this,"name","Format base");n(this,"options",{});this.options=this.optionsMerge(e)}optionsDefault(){return{type:null}}optionsMerge(e={}){return{...this.optionsDefault(),...e}}itemsTypes(){return{default:()=>null}}get(){const e=this.itemsTypes();if(typeof e[this.options.type]>"u")throw new Error(`${this.name} "${this.options.type}" does not exists`);return e[this.options.type]()}}class f extends p{constructor(){super(...arguments);n(this,"name","Three Geometry")}optionsDefault(){return{type:null,radius:1,length:1,capSegments:4,radialSegments:8,width:1,height:1,depth:1}}itemsTypes(){return{capsule:()=>new D(this.options.radius,this.options.length,this.options.capSegments,this.options.radialSegments),cube:()=>new B(this.options.width,this.options.height,this.options.depth)}}}class g extends p{constructor(){super(...arguments);n(this,"name","Three Material")}optionsDefault(){return{type:"basic",color:16777215}}itemsTypes(){return{basic:()=>new U({...this.options,type:void 0})}}}class W extends p{constructor(){super(...arguments);n(this,"name","Rapier Shape")}optionsDefault(){return{type:null,radius:1,length:1,capSegments:4,radialSegments:8,width:1,height:1,depth:1}}itemsTypes(){return{capsule:()=>c.ColliderDesc.capsule(this.options.length/2,this.options.radius),cube:()=>c.ColliderDesc.cuboid(this.options.width/2,this.options.height/2,this.options.depth/2)}}}class w extends p{constructor(){super(...arguments);n(this,"name","Rapier Body")}optionsDefault(){return{type:"dynamic",mass:1,restitution:1,canSleep:!1}}itemsTypes(){return{fixed:()=>c.RigidBodyDesc.fixed(),dynamic:()=>c.RigidBodyDesc.dynamic()}}}export{_ as S,K as a};
