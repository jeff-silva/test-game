var w=Object.defineProperty;var x=(o,e,t)=>e in o?w(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var c=(o,e,t)=>x(o,typeof e!="symbol"?e+"":e,t);import{_ as b}from"./B5jSB1xc.js";import{u as M}from"./cJqk34i8.js";import{O as h}from"./D3Mqfikn.js";import{T as S,L as v,c as C,d as z,e as y,S as A,P as k,C as P,W as B,g as u,Q as E,f as D,B as L,h as O,j as T,k as R,l as _,m as G,i as I,n as j,o as F,p as N,b as U,q as V,r as W,s as q,t as H,M as J}from"./DQ4UCc7_.js";import{G as Q}from"./BCwzVlOA.js";import{O as K}from"./C7Qk42do.js";import{_ as l}from"./vUEbHlag.js";import{n as Y,p as $,m as X,w as Z,o as ee,a as m}from"./ezY9ZAhu.js";import"./Cpj98o6Y.js";class te{constructor(e={}){c(this,"helpers",{});c(this,"events",[]);c(this,"rapierPhysics",{});c(this,"scripts",[]);this.options={el:null,debug:!1,assets:{},...e}}async init(){if(!this.options.el)throw new Error("options.el not defined");this.busy=!0,this.THREE=S,this.RAPIER=h,await this.rapierInit(),await this.threeInit(),await this.helpersInit(),this.input=new ie(this),this.busy=!1,this.create(),this.update()}resize(){const e={width:this.width,height:this.height};this.width=this.canvas.offsetWidth,this.height=this.canvas.offsetHeight,this.aspect=this.width/this.height,this.renderer.setSize(this.width,this.height),this.camera.aspect=this.aspect,this.camera.updateProjectionMatrix(),this.dispatch("resize",{oldSize:e})}create(){this.onCreate(),this.dispatch("create")}update(){this.onUpdate(),this.dispatch("update"),this.debug&&this.debug.update(),this.scripts.map(t=>{t.onUpdate()});for(let t in this.rapierPhysics){const{mesh:r,body:i,shape:n}=this.rapierPhysics[t];typeof i.translation=="function"&&r.position.copy(i.translation()),typeof i.rotation=="function"&&r.quaternion.copy(i.rotation())}const e=this.clock.getDelta();this.world.timestep=Math.min(e,.1),this.world.step(),this.renderer.render(this.scene,this.camera),requestAnimationFrame(()=>this.update())}async rapierInit(){await h.init(),this.world=new h.World({x:0,y:-9.81,z:0}),this.debug=null,this.options.debug&&setTimeout(()=>{this.debug=new class{constructor(e){this.parent=e,this.mesh=new v(new C,new z({color:16777215,vertexColors:!0})),this.mesh.frustumCulled=!1,this.parent.scene.add(this.mesh)}update(){const{vertices:e,colors:t}=this.parent.world.debugRender();this.mesh.geometry.setAttribute("position",new y(e,3)),this.mesh.geometry.setAttribute("color",new y(t,4))}}(this)},10)}async threeInit(){this.canvas=document.querySelector(this.options.el),this.width=this.canvas.offsetWidth,this.height=this.canvas.offsetHeight,this.aspect=this.width/this.height,this.scene=new A,this.scene.background=null,this.camera=new k(50,this.aspect,1,1e3),this.clock=new P,this.renderer=new B({antialias:!0,alpha:!0}),this.canvas.innerHTML="",this.canvas.style.position="relative",this.canvas.style.minHeight="100px",this.canvas.appendChild(this.renderer.domElement),this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%",this.resize(),window.addEventListener("resize",()=>this.resize()),this.assets=await this.assetsLoad()}async helpersInit(){this.helpers.Vec3=(e={})=>{e=JSON.parse(JSON.stringify(e));let t=new u(e.x||0,e.y||0,e.z||0);return t.toArray=()=>[t.x,t.y,t.z],t.toJson=()=>({x:t.x,y:t.y,z:t.z}),t},this.helpers.Quat=(e={})=>{const t=new E(e.x||0,e.y||0,e.z||0,e.w||0);return t.toArray=()=>[t.x,t.y,t.z,t.w],t.toJson=()=>({x:t.x,y:t.y,z:t.z,w:t.w}),t}}assetsLoad(){return new Promise((e,t)=>{let r=this.preload();Object.entries(r).length==0&&e({});const i={gltf:s=>new Q(n).load(s.url,a=>{s.loaded=!0,s.content=a})},n=Object.assign(new D,{onProgress:(s,a,d)=>{},onLoad:()=>{e(r)}});Object.entries(r).map(([s,a])=>{a.loaded=!1,a.ext=a.url.split("?").at(0).split(".").at(-1),a.content=null,typeof i[a.ext]=="function"&&i[a.ext](a)})})}on(e,t){this.events.push({event:e,call:t})}dispatch(...e){const t=e.shift();this.events.map(r=>{r.event==t&&r.call(...e)})}uuid(){let e=l.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){let r=(e+l.random(16))%16|0;return e=Math.floor(e/16),(t=="x"?r:r&3|8).toString(16)})}switch(e,t={},r=null){return t[e]?t[e]():r}threeMeshOptions(e={}){return l.merge({geometry:{type:"box",radius:1,length:1,capSegments:4,radialSegments:8,heightSegments:16,openEnded:!1,thetaStart:0,width:1,height:1,depth:1,thetaLength:Math.PI*2,radiusTop:1,radiusBottom:1,widthSegments:32,phiStart:0,phiLength:Math.PI*2},material:{type:"basic",color:16777215},mesh:{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0,w:0}}},e)}threeGetMesh(e){let t=null;return typeof e=="string"?(t=this.scene.getObjectByName(e),t||(t=this.scene.getObjectById(e))):t=e,t||null}threeMesh(e={}){e=this.threeMeshOptions(e);const t=this.switch(e.geometry.type,{box:()=>new L(e.geometry.width,e.geometry.height,e.geometry.depth),capsule:()=>new O(e.geometry.radius,e.geometry.length,e.geometry.capSegments,e.geometry.radialSegments),cone:()=>new T(e.geometry.radius,e.geometry.height,e.geometry.radialSegments,e.geometry.heightSegments,e.geometry.openEnded,e.geometry.thetaStart,e.geometry.thetaLength),cylinder:()=>new R(e.geometry.radiusTop,e.geometry.radiusBottom,e.geometry.height,e.geometry.radialSegments,e.geometry.heightSegments,e.geometry.openEnded,e.geometry.thetaStart,e.geometry.thetaLength),plane:()=>new _(e.geometry.width,e.geometry.height,e.geometry.widthSegments,e.geometry.heightSegments),sphere:()=>new G(e.geometry.radius,e.geometry.widthSegments,e.geometry.heightSegments,e.geometry.phiStart,e.geometry.phiLength,e.geometry.thetaStart,e.geometry.thetaLength)});let r={...e.material};delete r.type;const i=this.switch(e.material.type,{basic:()=>new I(r),depth:()=>new j(r),lambert:()=>new F(r),matcap:()=>new N(r),normal:()=>new U(r),phong:()=>new V(r),physical:()=>new W(r),standard:()=>new q(r),toon:()=>new H(r)}),n=new J(t,i);return n.position.set(e.mesh.position.x||0,e.mesh.position.y||0,e.mesh.position.z||0),n.quaternion.set(e.mesh.rotation.x||0,e.mesh.rotation.y||0,e.mesh.rotation.z||0,e.mesh.rotation.w||0),n}rapierPhysicsOptions(e={}){return l.merge({canSleep:!1,restitution:.5,mass:1,friction:.5,sensor:!1,linvel:{x:0,y:0,z:0},angvel:{x:0,y:0,z:0}},e)}rapierBody(e){e=l.merge(this.rapierPhysicsOptions(),{type:"dynamic",position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0,w:1}},e);let t=this.switch(e.type,{dynamic:()=>h.RigidBodyDesc.dynamic(),fixed:()=>h.RigidBodyDesc.fixed(),kinematicVelocityBased:()=>h.RigidBodyDesc.kinematicVelocityBased(),kinematicPositionBased:()=>h.RigidBodyDesc.kinematicPositionBased()});return this.world.createRigidBody(t.setTranslation(e.position.x||0,e.position.y||0,e.position.z||0).setRotation(e.rotation).setCanSleep(e.canSleep).setLinvel(e.linvel.x,e.linvel.y,e.linvel.z).setAngvel(e.angvel))}rapierShape(e){if(e=l.merge({type:"box",geometry:{width:1,height:1,depth:1,length:1,radius:1},mesh:null},this.rapierPhysicsOptions(e)),e.type=="trimesh"){if(!e.mesh)throw new Error('"mesh" param is required for type "trimesh"');if(!e.mesh.isMesh)throw new Error('Param "mesh.isMesh" is false. This need to be true')}const t=e.geometry;let r=this.switch(e.type,{box:()=>h.ColliderDesc.cuboid(t.width,t.height,t.depth),capsule:()=>h.ColliderDesc.capsule(t.length/2,t.radius),cone:()=>null,cylinder:()=>null,plane:()=>null,sphere:()=>h.ColliderDesc.ball(t.radius),trimesh:()=>{const i=e.mesh.geometry.clone();i.applyMatrix4(e.mesh.matrixWorld),i.computeVertexNormals();let n=i.attributes.position.array,s=i.index.array;return h.ColliderDesc.trimesh(new Float32Array(new Float32Array(n)),new Uint32Array(new Uint32Array(s))).setActiveEvents(h.ActiveEvents.COLLISION_EVENTS)}});if(!r)throw new Error(`Undefined shape "${t.type}"`);return r.setMass(e.mass).setRestitution(e.restitution).setFriction(e.friction).setSensor(e.sensor)}rapierPhysicsAdd(e,t,r){const i=this.uuid(),n=this.world.createCollider(r,t),s={uuid:i,mesh:e,body:t,shape:r,collider:n};return this.rapierPhysics[i]=s,s}rapierPhysicsApply(e,t,r,i={}){if(e=this.threeGetMesh(e),!e)throw new Error("Mesh not found");i=this.rapierPhysicsOptions(i);let n=this.rapierBody({type:t,...i,position:{x:e.position.x,y:e.position.y,z:e.position.z},rotation:{x:e.rotation.x,y:e.rotation.y,z:e.rotation.z,w:e.rotation.w||1}}),s=this.rapierShape({type:r,...i,mesh:e});return this.rapierPhysicsAdd(e,n,s)}characterCameraControllerCreate(e={}){return new class{constructor(t,r){this.parent=t,this.options=l.merge({input:{forward:["w"],backward:["s"],left:["a"],right:["d"],jumb:["Space"]},camera:{type:"First"},mouse:{sensitivity:.5},player:{speed:.06,jumpForce:.02,position:{x:0,y:0,z:0},mesh:{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0}}}},r),this.controller=t.world.createCharacterController(.01),this.controller.setSlideEnabled(!0),this.controller.setMaxSlopeClimbAngle(45*Math.PI/180),this.controller.setMinSlopeSlideAngle(30*Math.PI/180),this.controller.enableAutostep(.5,.2,!0),this.controller.enableSnapToGround(.5),this.controller.setApplyImpulsesToDynamicBodies(!0),this.controller.setCharacterMass(1),this.player={mesh:this.parent.threeMesh({material:{type:"basic",color:16711680},geometry:{type:"capsule",radius:1,length:1.7},mesh:this.options.player.mesh}),body:this.parent.rapierBody({type:"kinematicPositionBased",position:this.options.player.mesh.position,rotation:this.options.player.mesh.rotation}),shape:this.parent.rapierShape({type:"capsule",radius:1,length:1.7}),collider:null},this.parent.scene.add(this.player.mesh),this.player=this.parent.rapierPhysicsAdd(this.player.mesh,this.player.body,this.player.shape),this.player.speed=0,this.player.gravity=0,this.player.grounded=!1,this.parent.on("update",()=>{const{Vec3:i,Quat:n}=this.parent.helpers;this.player.grounded=this.controller.computedGrounded(),this.player.gravity=this.player.grounded?0:Math.max(-9.2,this.player.gravity-.005);let s=i(),a=i(),d=i();this.parent.input.keyboard(this.options.input.forward)&&(a.z=1),this.parent.input.keyboard(this.options.input.backward)&&(a.z=-1),this.parent.input.keyboard(this.options.input.left)&&(a.x=1),this.parent.input.keyboard(this.options.input.right)&&(a.x=-1),this.parent.input.keyboard(this.options.input.jump)&&this.player.grounded&&(this.player.gravity+=this.options.player.jumpForce),this.player.speed=0,s.subVectors(a,d).normalize().multiplyScalar(this.options.player.speed*-1);const p=this.parent.camera.getWorldDirection(new u),g=Math.atan2(p.x,p.z);s.applyAxisAngle(i({x:0,y:1,z:0}),g).multiplyScalar(-1);const f={x:s.x,y:this.player.gravity,z:s.z};this.controller.computeColliderMovement(this.player.collider,f),this.player.body.setNextKinematicTranslation(i().copy(this.player.body.translation()).add(this.controller.computedMovement()))})}}(this,e)}getOrbitControls(){let e=new K(this.camera,this.renderer.domElement);return this.on("update",()=>{e.update()}),e}scriptAttach(e,t){return e=Array.isArray(e)?e:[e],e=e.map(r=>(typeof r=="string"&&(r=this.scene.getObjectByName(r)),r&&(r=new t(this,r),this.scripts.push(r),r.onCreate()),r)).filter(r=>!!r),e}preload(){return{}}onCreate(){}onUpdate(){}}class re{constructor(e,t){this.parent=e,this.mesh=t}onCreate(){}onUpdate(){}}class ie{constructor(e){this.parent=e,this.keyboardData={},this.events=[],this.keyboardEventsInit(),this.events.map(({evt:t,call:r})=>{document.addEventListener(t,r)})}keyboardEventsInit(){this.events.push({evt:"keydown",call:e=>{this.keyboardData[e.key]=e,this.keyboardData[e.code]=e}}),this.events.push({evt:"keyup",call:e=>{this.keyboardData[e.key]&&delete this.keyboardData[e.key],this.keyboardData[e.code]&&delete this.keyboardData[e.code]}})}keyboard(e){e=Array.isArray(e)?e:[e];for(let t in e){const r=e[t];return typeof this.keyboardData[r]>"u"?void 0:this.keyboardData[r]}return null}}const ue={__name:"rapier-meta-test",setup(o){const e=M();class t extends te{preload(){return{scene:{url:e.baseUrl("assets/threejs/models/basic/scene.gltf")}}}onCreate(){this.scene.add(this.assets.scene.content.scene),this.orbitControls=this.getOrbitControls(),this.camera.position.set(0,10,10),this.rapierPhysicsApply("Floor","fixed","trimesh"),this.scriptAttach(["Cube001","Cube002","Cube003"],r),this.player=this.characterCameraControllerCreate({player:{mesh:{position:{y:6}}}})}}class r extends re{onCreate(){this.mesh.rotation.y=1,this.parent.rapierPhysicsApply(this.mesh,"dynamic","box")}}const i=new t({el:"#game",debug:!0});return Y(async()=>{await i.init()}),$(()=>{location.reload()}),(n,s)=>{const a=b;return ee(),X(a,{name:"main"},{default:Z(()=>s[0]||(s[0]=[m("div",{id:"game",style:{width:"100%",height:"600px",position:"relative"}},null,-1),m("a",{href:""},"Refresh",-1)])),_:1})}}};export{ue as default};
